name: Validate JSON Files

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install jq
      run: sudo apt-get install jq
    
    - name: Validate JSON files
      run: |
        echo "ğŸ” Validating JSON files..."
        failed=0
        
        for file in *.json; do
          if [ -f "$file" ]; then
            echo "Validating $file..."
            if jq . "$file" > /dev/null 2>&1; then
              echo "âœ… $file is valid"
            else
              echo "âŒ $file is invalid"
              failed=1
            fi
          fi
        done
        
        if [ $failed -eq 1 ]; then
          echo "ğŸ’¥ JSON validation failed!"
          exit 1
        else
          echo "ğŸ‰ All JSON files are valid!"
        fi
    
    - name: Check file sizes
      run: |
        echo "ğŸ“Š Checking file sizes..."
        for file in *.json; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file")
            size_mb=$((size / 1024 / 1024))
            echo "$file: ${size} bytes (${size_mb} MB)"
            
            if [ $size -gt 10485760 ]; then  # 10MB limit
              echo "âš ï¸  Warning: $file is larger than 10MB"
            fi
          fi
        done
    
    - name: Verify required fields
      run: |
        echo "ğŸ” Verifying data structure..."
        
        # Check if institutions file has required structure
        if [ -f "institutions-diy.json" ]; then
          if jq -e '.yogyakarta_kota' institutions-diy.json > /dev/null; then
            echo "âœ… institutions-diy.json has correct structure"
          else
            echo "âŒ institutions-diy.json missing required structure"
            exit 1
          fi
        fi
        
        # Check if competitions file has required structure
        if [ -f "competitions-indonesia.json" ]; then
          if jq -e '.robotics' competitions-indonesia.json > /dev/null; then
            echo "âœ… competitions-indonesia.json has correct structure"
          else
            echo "âŒ competitions-indonesia.json missing required structure"
            exit 1
          fi
        fi
        
        echo "ğŸ‰ Data structure validation passed!"
